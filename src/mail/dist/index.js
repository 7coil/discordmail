parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"BkE3":[function(require,module,exports) {
"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var t,n=e(require("node-fetch")),r=e(require("form-data"));!function(e){e[e.WEBHOOK_ACCOUNT=0]="WEBHOOK_ACCOUNT",e[e.USER_ACCOUNT=1]="USER_ACCOUNT"}(t||(t={}));var i=function(){function e(e){var t=e.id,n=e.type,r=e.payload;this.id=t,this.type=n,this.payload=r}return e.prototype.sendMail=function(e){if(this.type===t.WEBHOOK_ACCOUNT){var i=new r.default;i.append("payload_json",JSON.stringify(e.getEmbed())),n.default(this.payload,{method:"POST",body:i})}},e.getAccountFromEmail=function(t,n){return new Promise(function(r,i){if(!n.toLowerCase().endsWith("@"+process.env.DOMAIN_NAME))return r(null);var o=n.substring(0,n.length-process.env.DOMAIN_NAME.length-1);t.query("SELECT * FROM accounts WHERE id = ?",[o],function(t,n,o){if(!t)return 0===n.length?r(null):r(new e(n[0]));i(t)})})},e}();exports.default=i;
},{}],"p4wU":[function(require,module,exports) {
"use strict";var t=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});var e=t(require("./Account")),n=t(require("html-to-text")),i=function(){function t(t){var e=t.mail,n=t.stream,i=t.session,o=t.callback,s=t.sqlConnection;this.mailObject=e,this.stream=n,this.session=i,this.callback=o,this.sqlConnection=s,this.dateLoaded=new Date}return t.prototype.contentRequiresConversion=function(){return!this.mailObject.text&&!!this.mailObject.html},t.prototype.contentRequiresTruncation=function(){return null!==this.getContents()&&this.getContents().length>2e3},t.prototype.emailContainsAttachments=function(){return this.mailObject.attachments.length>0},t.prototype.getRecipient=function(){var t=this;return new Promise(function(n,i){var o=[];t.mailObject.to&&o.push.apply(o,t.mailObject.to.value.map(function(t){return t.address})),t.mailObject.headers.get("x-forwarded-to")&&o.push(t.mailObject.headers.get("x-forwarded-to")),t.session.envelope.rcptTo.length>0&&o.push.apply(o,t.session.envelope.rcptTo.map(function(t){return t.address})),Promise.all(o.map(function(n){return e.default.getAccountFromEmail(t.sqlConnection,n)})).then(function(t){var e=t.filter(function(t){return!!t});n(e[0]||null)})})},t.prototype.getTitle=function(){return this.mailObject.subject||"_Untitled E-Mail_"},t.prototype.getAuthor=function(){return this.mailObject.from?this.mailObject.from.text.length>256?this.mailObject.from.text.substring(0,250)+"...":this.mailObject.from.text:"_No Author Identified_"},t.prototype.getContents=function(){return this.contentRequiresConversion()?!1===this.mailObject.html?null:n.default.fromString(this.mailObject.html):0===this.mailObject.text.trim().length?null:this.mailObject.text},t.prototype.getTruncatedContents=function(){return this.contentRequiresTruncation()?this.getContents().substring(0,1995)+"...":this.getContents()},t.prototype.getDate=function(){return this.mailObject.date||this.dateLoaded},t.prototype.getEmbed=function(){var t=[];return this.contentRequiresConversion()&&t.push({name:"Note",value:"This email has been converted from _HTML_ to _Plain Text_."}),this.contentRequiresTruncation()&&t.push({name:"Note",value:"This email has been truncated to fit under 2000 characters."}),this.emailContainsAttachments()&&t.push({name:"Attachments",value:"This email contains attachments."}),{title:this.getTitle(),description:this.getTruncatedContents(),timestamp:this.getDate(),author:{name:this.getAuthor()},fields:t,footer:{text:"https://discordmail.com/"}}},t}();exports.default=i;
},{"./Account":"BkE3"}],"Focm":[function(require,module,exports) {
"use strict";var e=require("smtp-server"),n=require("mailparser"),a=s(require("mysql")),r=s(require("./Mail"));function s(e){return e&&e.__esModule?e:{default:e}}const o=a.default.createConnection({host:"database",user:"discordmail",password:"discordmail",database:"discordmail"});o.query("\n  CREATE TABLE IF NOT EXISTS accounts (\n    id          VARCHAR(512)  PRIMARY KEY,\n    type        TINYINT(1)     NOT NULL,\n    payload     VARCHAR(512)  NOT NULL\n  );\n"),o.query("\n  REPLACE INTO accounts (id, type, payload) VALUES ('test', 0, 'https://canary.discordapp.com/api/webhooks/697945595025031208/8nHYS-Pv_VJy1hZQsLei9PpPJ7UNNgOFiLXb9pNwmLjpSL0ogc4fNPbff0yItlq5N-h2')\n");const t=new e.SMTPServer({banner:"DiscordMail 2.0",authOptional:!0,onData(e,a,s){(0,n.simpleParser)(e).then(n=>new r.default({mail:n,stream:e,session:a,callback:s,sqlConnection:o})).then(async e=>{console.log(e,n);const n=await e.getRecipient();if(n)return n.sendMail(e)}).then(()=>s()).catch(e=>{let n;(n=e instanceof Error?e:new Error(e)).responseCode=552,console.log(n),s(n)})}});t.listen(25),t.on("error",e=>{console.log(e.message)});
},{"./Mail":"p4wU"}]},{},["Focm"], null)
//# sourceMappingURL=/index.js.map